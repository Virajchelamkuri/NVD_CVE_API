<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>CVE Detail</title>
<style>
body { font-family: Arial, sans-serif; background:#F7F9FA; margin:0; padding:0; }
.container { max-width:1000px; margin:30px auto; padding:22px; background:#fff; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
h1 { color:#2C3E50; margin-bottom:10px; }
.section { margin-top:12px; margin-bottom:10px; }
.card { padding:12px; background:#fbfbff; border-left:6px solid #34495E; border-radius:4px; margin-bottom:12px; }
.table { width:100%; border-collapse:collapse; margin-top:8px; }
.table th, .table td { border:1px solid #e6e9ec; padding:8px 10px; text-align:left; vertical-align: middle; }
.table th { background:#34495E; color:#fff; }
.badge { padding:4px 8px; border-radius:4px; color:white; font-weight:700; display:inline-block; }
.badge.low { background:#27AE60; }
.badge.medium { background:#D35400; }
.badge.high { background:#C0392B; }
label.small { color:#666; font-size:0.95em; display:block; margin-bottom:6px; }
.button { background:#2980B9; color:white; padding:8px 12px; border:none; border-radius:6px; cursor:pointer; margin-top:12px;}
pre { background:#f1f3f6; padding:8px; border-radius:6px; overflow:auto; font-size:0.9em; }
@media (max-width:768px){ .container { padding:12px; } .table th, .table td { font-size:12px; } }
</style>
</head>
<body>
<div class="container">
    <h1 id="cveTitle">CVE Details</h1>

    <div id="basic" class="card"></div>

    <div>
        <h3 style="color:#2C3E50; margin-bottom:8px">CVSS V2 Metrics</h3>
        <div id="cvssV2" class="card"></div>
    </div>

    <div>
        <h3 style="color:#2C3E50; margin-top:10px">Scores</h3>
        <div id="scores" class="card"></div>
    </div>

    <div>
        <h3 style="color:#2C3E50; margin-top:10px">CPE / Vulnerable Products</h3>
        <div id="cpeList" class="card"></div>
    </div>

    <div>
        <h3 style="color:#2C3E50; margin-top:10px">References</h3>
        <div id="refs" class="card"></div>
    </div>

    <button class="button" onclick="window.history.back()">Back</button>
</div>

<script>
const API_BASE = window.location.origin;

function getCveId() {
    const p = new URLSearchParams(window.location.search);
    return p.get('cve_id');
}

function severityLabelFromScore(score){
    if(score == null) return {label:'N/A', cls:'low'};
    if(score >= 7) return {label:'HIGH', cls:'high'};
    if(score >= 4) return {label:'MEDIUM', cls:'medium'};
    return {label:'LOW', cls:'low'};
}

function renderBasic(data){
    document.getElementById('cveTitle').innerText = data.cve_id;
    const html = `
        <div><label class="small">Description:</label><div>${data.description || '-'}</div></div>
        <div style="margin-top:8px;"><label class="small">Published:</label><div>${new Date(data.published_date).toLocaleString()}</div></div>
        <div style="margin-top:8px;"><label class="small">Last Modified:</label><div>${new Date(data.last_modified).toLocaleString()}</div></div>
    `;
    document.getElementById('basic').innerHTML = html;
}

function renderCvssV2Block(cvss_v2){
    if(!cvss_v2 || Object.keys(cvss_v2).length===0){
        document.getElementById('cvssV2').innerHTML = '<div>- No CVSS V2 data available -</div>';
        return;
    }
    const severity = severityLabelFromScore(cvss_v2.baseScore);
    const table = `
        <div style="margin-bottom:8px;"><strong>Severity:</strong> <span class="badge ${severity.cls}">${severity.label}</span> &nbsp;&nbsp; <strong>Score:</strong> <span style="color:#C0392B;font-weight:700">${cvss_v2.baseScore ?? '-'}</span></div>

        <div style="margin-top:5px;"><label class="small">Vector String:</label><div>${cvss_v2.vectorString || '-'}</div></div>

        <table class="table">
            <thead>
                <tr>
                    <th>Access Vector</th>
                    <th>Access Complexity</th>
                    <th>Authentication</th>
                    <th>Confidentiality Impact</th>
                    <th>Integrity Impact</th>
                    <th>Availability Impact</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>${cvss_v2.accessVector || '-'}</td>
                    <td>${cvss_v2.accessComplexity || '-'}</td>
                    <td>${cvss_v2.authentication || '-'}</td>
                    <td>${cvss_v2.confidentialityImpact || '-'}</td>
                    <td>${cvss_v2.integrityImpact || '-'}</td>
                    <td>${cvss_v2.availabilityImpact || '-'}</td>
                </tr>
            </tbody>
        </table>
    `;
    document.getElementById('cvssV2').innerHTML = table;
}

function renderScores(cvss_v2, cvss_v3){
    const explo = (cvss_v2 && cvss_v2.exploitabilityScore) ? cvss_v2.exploitabilityScore : '-';
    const impact = (cvss_v2 && cvss_v2.impactScore) ? cvss_v2.impactScore : '-';
    const v3score = (cvss_v3 && cvss_v3.baseScore) ? cvss_v3.baseScore : '-';

    const html = `
        <div style="margin-bottom:8px"><strong>CVSS v3 Base Score:</strong> ${v3score} &nbsp;&nbsp; <strong>CVSS v2 Exploitability:</strong> ${explo}</div>
        <div><strong>CVSS v2 Impact Score:</strong> ${impact}</div>
    `;
    document.getElementById('scores').innerHTML = html;
}

function renderProducts(products){
    if(!products || products.length===0){
        document.getElementById('cpeList').innerHTML = '<div>- No vulnerable products / CPEs -</div>';
        return;
    }
    let rows = '';
    products.forEach(p => {
        rows += `<tr>
            <td>${p.criteria}</td>
            <td>${p.matchCriteriaId || '-'}</td>
            <td style="text-align:center">${p.vulnerable ? 'Yes' : 'No'}</td>
        </tr>`;
    });
    const table = `
        <table class="table">
            <thead><tr><th>Criteria</th><th>Match Criteria ID</th><th>Vulnerable</th></tr></thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    document.getElementById('cpeList').innerHTML = table;
}

function renderReferences(refs){
    if(!refs || refs.length===0){
        document.getElementById('refs').innerHTML = '<div>- No references -</div>';
        return;
    }
    let html = '<ul>';
    refs.forEach(r => {
        html += `<li><a href="${r.url}" target="_blank" rel="noopener">${r.name || r.url}</a></li>`;
    });
    html += '</ul>';
    document.getElementById('refs').innerHTML = html;
}

async function fetchAndRender(){
    const cve = getCveId();
    if(!cve) { alert('No CVE id in URL'); return; }
    const res = await fetch(`${API_BASE}/cves/${cve}`);
    if(!res.ok){
        alert('Error fetching CVE: ' + res.status);
        return;
    }
    const data = await res.json();
    renderBasic(data);
    renderCvssV2Block(data.cvss_v2 || {});
    renderScores(data.cvss_v2 || {}, data.cvss_v3 || {});
    renderProducts(data.products || []);
    renderReferences(data.references || []);
}

document.addEventListener('DOMContentLoaded', fetchAndRender);
</script>
</body>
</html>
